version: '3.8'

services:
  # 1. 資料庫服務 (PostgreSQL)
  db:
    image: postgres:15-alpine
    restart: always
    volumes:
      # 持久化資料庫檔案，容器刪除後資料還在
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=hui_embroidery_db
      - POSTGRES_USER=hui_embroidery_user
      - POSTGRES_PASSWORD=hui_embroidery_pass
    ports:
      # (選填) 如果想用 DBeaver/TablePlus 連進去看資料，把這行打開
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U hui_embroidery_user -d hui_db" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. Web 應用服務 (Django/Wagtail)
  web:
    build: .
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      # [關鍵] 將當前目錄掛載進去，實現 Hot-Reload (改 Code 即時生效)
      - .:/app
      # [關鍵] 將上傳的圖片持久化，避免容器重啟後圖片消失
      - media_volume:/app/media
    ports:
      - "8000:8000"
    depends_on:
      # 確保資料庫啟動後才啟動 Web
      db:
        condition: service_healthy
    environment:
      # 這些變數會傳入 Django settings.py
      - DATABASE_NAME=hui_embroidery_db
      - DATABASE_USER=hui_embroidery_user
      - DATABASE_PASSWORD=hui_embroidery_pass
      - DATABASE_HOST=db
      - DATABASE_PORT=5432
      # 開發模式開關
      - DJANGO_DEBUG=True

# 定義 Volumes
volumes:
  postgres_data:
  media_volume:
